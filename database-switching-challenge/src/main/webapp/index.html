<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>J-NoPo - Are you a Joken-po master?</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
            integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
            crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Marck+Script&amp;family=Montserrat:wght@800&amp;display=swap"
          rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/gotham-bold" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/gotham-book" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css"
          integrity="sha512-10/jx2EXwxxWqCLX/hHth/vu2KY3jCF70dCQB8TSgNjbCVAC/8vai53GfMDrO2Emgwccf2pJqxct9ehpzG+MTw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;1,100;1,200;1,300;1,400;1,500&amp;display=swap"
          rel="stylesheet">
    <meta name="theme-color" content="#1976d2">
    <style>
        body {
            height: 100%;
        }

        body {
            display: flex;
            align-items: center;
            background-color: #f5f5f5;
        }

        .form-signin {
            max-width: 400px;
            padding: 15px;
        }

        .form-signin .form-floating:focus-within {
            z-index: 2;
        }

        .form-signin input[type="email"] {
            margin-bottom: -1px;
            border-bottom-right-radius: 0;
            border-bottom-left-radius: 0;
        }

        .form-signin input[type="password"] {
            margin-bottom: 10px;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }

        .hide {
            display: none;
        }
    </style>
</head>
<body class="text-center">

<main class="form-signin w-100 m-auto">
    <div class="card gamePanel hide" style="width: 100%;">
        <div class="card-body">
            <div class="container waitingPlayers hide ">
                <div class="row justify-content">
                    <div class="col-1 spinner-border text-warning" role="status"></div>
                    <div class="col-10 m-0">
                        <img src="img/waiting.png" style="width: 110%"/>
                    </div>
                </div>
            </div>

            <div class="container youWin hide">
                <div class="row justify-content">
                    <div class="col-12 m-0">
                        <img src="img/youwin.png" style="width: 100%"/>
                    </div>
                </div>
                <div class="row justify-content m-3">
                    <div class=" card-title label">Opponent: <span class="opponentName"></span></div>
                </div>
                <img class="opponentImages" src="img/ROCK.png" style="margin-bottom:10px;margin-top:10px;width: 30%"/>
                <div class="row justify-content  m-3">
                    <div class=" card-title label">You</div>
                </div>

                <img class="myImage" src="img/ROCK.png" style="margin-bottom:10px;margin-top:10px;width: 50%"/>

            </div>

            <div class="container youLose hide">
                <div class="row justify-content">
                    <div class="col-12 m-0">
                        <img src="img/youlose.png" style="width: 100%"/>
                    </div>
                </div>
                <div class="row justify-content m-3">
                    <div class="card-title label">Opponent: <span class="opponentName"></span></div>
                </div>
                <img class="opponentImages" src="img/ROCK.png" style="margin-bottom:10px;margin-top:10px;width: 50%"/>
                <div class="row justify-content  m-3">
                    <div class="card-title label">You</div>
                </div>

                <img class="myImage" src="img/ROCK.png" style="margin-bottom:10px;margin-top:10px;width: 30%"/>

            </div>

            <div class="container tied hide">
                <div class="row justify-content">
                    <div class="col-12 m-0">
                        <img src="img/tied.png" style="width: 100%"/>
                    </div>
                </div>
                <div class="row justify-content m-3">
                    <div class="card-title label">Opponent: <span class="opponentName"></span></div>
                </div>
                <img class="opponentImages" src="img/ROCK.png" style="margin-bottom:10px;margin-top:10px;width: 35%"/>
                <div class="row justify-content  m-3">
                    <div class="card-title label">You</div>
                </div>

                <img class="myImage" src="img/ROCK.png" style="margin-bottom:10px;margin-top:10px;width: 35%"/>

            </div>

            <div class="container abandoned hide">
                <div class="row justify-content">
                    <div class="col-12 m-0">
                        <img src="img/abandoned.png" style="width: 100%"/>
                    </div>
                </div>
                <div class="row justify-content m-3">
                    <div class="card-title label">Opponent: <span class="opponentName"></span></div>
                </div>
                <img class="opponentImages" src="img/whereistheopponent.png"
                     style="margin-bottom:10px;margin-top:10px;width: 45%"/>
                <div class="row justify-content  m-3">
                    <div class=" card-title label">You</div>
                </div>

                <img class="myImage" src="img/ROCK.png" style="margin-bottom:10px;margin-top:10px;width: 25%"/>

            </div>

            <div class="container disconnected">
                <div class="row justify-content">
                    <div class="col-12 m-0">
                        <img src="img/disconnected.png" style="width: 100%"/>
                    </div>
                </div>

                <div id="errorToast" class="toast align-items-center text-bg-primary border-0" role="alert"
                     aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body" id="errorMessage">
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                                aria-label="Close"></button>
                    </div>
                </div>

            </div>


            <div class="container gameRunning hide ">
                <div class="row justify-content">
                    <img src="img/fight.png" style="width: 110%"/>
                </div>
                <div class="row">
                    <div class="gameRunning card-title label">Opponent: <span class="opponentName"></span></div>
                </div>
                <div class="row progress">
                    <div id="progress-bar" class="progress-bar progress-bar-striped bg-warning"
                         role="progressbar" aria-label="Animated striped example" aria-valuenow="75" aria-valuemin="0"
                         aria-valuemax="100" style="width: 100%"></div>
                </div>
            </div>
            <div class="board hide">
                <img class="myImage" src="img/ROCK.png" style="margin-bottom:10px;margin-top:10px;width: 100%"/>
                <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
                    <input type="radio" class="btn-check" value="ROCK" name="btnradio" id="btnradio1" autocomplete="off"
                           checked>
                    <label class="w-100 btn btn-lg  btn-outline-danger" for="btnradio1">
                        <img src="img/ROCK.png" class="w-100"/>
                    </label>

                    <input type="radio" class="btn-check" value="PAPER" name="btnradio" id="btnradio2"
                           autocomplete="off">
                    <label class="w-100 btn btn-lg  btn-outline-danger" for="btnradio2">
                        <img src="img/PAPER.png" class="w-100"/>
                    </label>

                    <input type="radio" class="btn-check" value="SCISSORS" name="btnradio" id="btnradio3"
                           autocomplete="off">
                    <label class="w-100 btn btn-lg  btn-outline-danger" for="btnradio3">
                        <img src="img/SCISSORS.png" class="w-100"/>
                    </label>
                </div>
            </div>

        </div>
        <div class="card-body tryPanel hide">
            <div class="dropdown">
                <a class="btn btn-danger btn-lg w-100 dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                   aria-expanded="false">
                    Try again?
                </a>
                <ul class="dropdown-menu w-100 text-center">
                    <li><a class="btn btn-lg btn-danger dropdown-item w-100 btnTryAgain" href="#">Yes!</a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="card-body leavePanel hide">
            <div class="dropdown">
                <a class="btn btn-danger btn-lg w-100 dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                   aria-expanded="false">
                    Leave Game
                </a>
                <ul class="dropdown-menu w-100 text-center">
                    <li><a class="btn btn-lg btn-danger dropdown-item w-100 leaveBtn" href="#">Are you sure?</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <form id="form" class="needs-validation" novalidate>
        <img src="img/logo.png" style="margin-bottom: 15px;" width="100%"/>
        <h1 class="h3 mb-3 fw-normal">Are you ready?</h1>
        <div class="form-floating">
            <input required="required" class="form-control" id="username" maxlength="20" placeholder="John Doe">
            <label for="username">Enter your name</label>
        </div>
        <button class="w-100 btn btn-lg btn-danger" type="submit">Let's go!</button>
    </form>


</main>

<script type="text/javascript">
    (() => {

        'use strict'

        const getProtocol = () => {
            if (location.protocol === "https:") {
                return "wss";
            }
            return "ws";
        }

        const getWebsocketAddress = () => {
            let url = location.href.slice(location.protocol.length, location.href.length);
            return `${getProtocol()}://${url.slice(0, url.lastIndexOf("/"))}`;
        }

        const hideNode = node => {
            node.classList.add('hide');

        }

        const showNode = node => {
            node.classList.remove('hide');
        }

        const singleHideOrShow = (element) => {
            return {
                element,
                show: () => showNode(element),
                hide: () => hideNode(element)
            }

        }
        const hideOrShow = (nodes) => {
            return {
                nodes,
                hide: () => {
                    nodes.forEach(hideNode);
                },
                show: () => {
                    nodes.forEach(showNode);
                }
            };

        }

        const form = document.getElementById("form");

        class ProgressBar {
            constructor() {
                this.element = document.getElementById("progress-bar")
            }

            reset() {
                this.element.style.width = "100%";
            }

            size() {
                return +this.element.style.width.replaceAll('%', '');
            }

            decrease(num) {
                const total = this.size();
                const newTotal = (total - num) < 0 ? 0 : total - num;
                this.element.style.width = `${newTotal}%`;
            }

            increase(num) {
                const total = this.size();
                const newTotal = (total + num) > 100 ? 100 : total + num;
                this.element.style.width = `${newTotal}%`;
            }
        }

        const btnradios = document.getElementsByName("btnradio")

        const updateMyImages = (movement) => {
            state.MOVEMENT = movement;
            document.querySelectorAll('.myImage')
                .forEach(image => {
                    image.src = `img/${movement}.png`;
                });
        }


        btnradios.forEach(btnradio => {
            btnradio.addEventListener('click', event => {
                const movement = event.target.value;
                updateMyImages(movement);
            }, false);

        })

        class BoardMovement {

            constructor() {
                this.btnradios = btnradios;
            }

            disable() {
                btnradios.forEach(btnradio => {
                    btnradio.disabled = 'disabled';
                })
            }

            enable() {
                btnradios.forEach(btnradio => {
                    btnradio.disabled = '';
                })
            }
        }

        const initialForm = singleHideOrShow(form);

        const gamePanel = hideOrShow(document.querySelectorAll(".gamePanel"))

        const boardMovement = new BoardMovement();

        const progressBar = new ProgressBar();

        const waitingPlayers = hideOrShow(document.querySelectorAll('.waitingPlayers'));

        const youWin = hideOrShow(document.querySelectorAll('.youWin'));

        const youLose = hideOrShow(document.querySelectorAll('.youLose'));

        const abandoned = hideOrShow(document.querySelectorAll('.abandoned'));

        const tied = hideOrShow(document.querySelectorAll('.tied'));

        const tryPanel = hideOrShow(document.querySelectorAll('.tryPanel'))

        const leavePanel = hideOrShow(document.querySelectorAll('.leavePanel'))

        const board = hideOrShow(document.querySelectorAll('.board'))

        const gameRunning = hideOrShow(document.querySelectorAll('.gameRunning'))

        const disconnected = hideOrShow(document.querySelectorAll('.disconnected'))

        const errorMessageElement = document.getElementById("errorMessage");

        const errorModalElement = document.getElementById("errorToast");

        const errorToast = bootstrap.Toast.getOrCreateInstance(errorModalElement);

        const errorCodes = {
            1000: "Normal Closure: This means that the connection was closed for expected reasons. The server and client both agree to close the connection, indicating a planned shutdown or completion of the data transfer.",
            1001: "Going Away: The server or client is shutting down or leaving the network.",
            1002: "Protocol Error: This could be due to a malformed frame or an unexpected sequence of frames.",
            1003: "Unsupported Data: The endpoint received data of a type it cannot accept (e.g., text data when it is expecting binary data).",
            1004: "Reserved: The specific meaning might be defined in the future.",
            1005: "No Status Received: Indicates that no status code was provided even though one was expected.",
            1006: "Abnormal Closure: The connection was closed abnormally.",
            1007: "Invalid frame payload data.",
            1008: "Policy Violation: The endpoint is terminating the connection because it has received a message that violates its policy.",
            1009: "Message Too Big: The endpoint is terminating the connection because a data frame was received that is too large.",
            1010: "Mandatory Extension: The client is terminating the connection because the server did not negotiate one or more extensions that the client finds necessary.",
            1011: "Internal Server Error: The server is terminating the connection because it encountered an unexpected condition that prevented it from fulfilling the request.",
            1012: "Service Restart: The server is terminating the connection due to a temporary condition, e.g., it is restarting.",
            1013: "Try Again Later: The server is terminating the connection due to a temporary condition, suggesting the client try again at a later time.",
            1014: "Bad Gateway: The server, acting as a gateway or proxy, received an invalid response from the upstream server.",
            1015: "TLS Handshake: The connection was closed due to a failure in the TLS handshake."
        };


        const showErrorMessagesIfNeeded = (code) => {
            if(code && code !== 1000) {
                const message = errorCodes[code];
                if (message) {
                    errorMessageElement.innerHTML = message;
                    errorToast.show();
                    return true;
                }
            }
            return false;
        }

        const hidePanels = () => {
            gamePanel.hide()
            waitingPlayers.hide();
            board.hide();
            youLose.hide();
            youWin.hide();
            abandoned.hide();
            leavePanel.hide();
            tryPanel.hide();
            tied.hide();
            disconnected.hide();
        }


        const updateOpponentName = (name) => {
            document.querySelectorAll(".opponentName")
                .forEach(div => {
                    div.innerHTML = name;
                })
        }
        const updateOpponentImages = (movement) => {
            document.querySelectorAll('.opponentImages')
                .forEach(image => {
                    image.src = `img/${'' === movement.trim() ? 'NONE' : movement}.png`;
                });
        }


        class State {

            constructor() {
                this.USERNAME = '';
                this.MOVEMENT = 'ROCK';
                this.OPPONENT_NAME = '';
                this.OPPONENT_MOVEMENT = '';
            }

        }

        const state = new State();


        form.addEventListener('submit', event => {
            let input = document.getElementById("username");
            event.preventDefault()
            event.stopPropagation()
            if (form.checkValidity()) {
                initialForm.hide();
                hidePanels();
                state.USERNAME = input.value;
                if (connected) {
                    socket.close();
                }
                connect();
            }
            form.classList.add('was-validated')
        }, false);


        let connected = false;
        let socket;

        document.querySelectorAll(".leaveBtn")
            .forEach(btn => {
                btn.addEventListener('click', () => {
                    socket.close();
                    waitingPlayers.hide();
                    gameRunning.hide();
                    board.hide();
                    youLose.hide();
                    youWin.hide();
                    abandoned.hide();
                    tied.hide();
                    leavePanel.hide();
                    tryPanel.hide();
                    gamePanel.hide();
                    disconnected.hide();

                    initialForm.show();
                }, false)
            });

        document.querySelectorAll(".btnTryAgain")
            .forEach(btn => {
                btn.addEventListener('click', () => {
                    if (connected) {
                        socket.close();
                    }
                    waitingPlayers.hide();
                    gameRunning.hide();
                    board.hide();
                    youLose.hide();
                    youWin.hide();
                    abandoned.hide();
                    tied.hide();
                    leavePanel.hide();
                    tryPanel.hide();
                    gamePanel.hide();
                    disconnected.hide();
                    initialForm.show();
                }, false);
            })

        const connect = () => {
            if (!connected) {
                const username = state.USERNAME;
                const wsURL = `${getWebsocketAddress()}/jnopo/${username}`;
                socket = new WebSocket(wsURL);
                socket.onopen = function () {
                    connected = true;
                    console.log("Connected to the web socket");
                    gamePanel.show();
                    board.show();
                    boardMovement.enable();
                };
                socket.onclose = function (evt) {
                    connected = false;
                    let logger = console.log;
                    if (showErrorMessagesIfNeeded(evt.code)) {
                        logger = console.error;
                        hidePanels();
                        gamePanel.show();
                        disconnected.show();
                        tryPanel.show();
                        showErrorMessagesIfNeeded();
                    }

                    logger({
                        code: evt.code,
                        wasClean: evt.wasClean,
                        reason: evt.reason,
                        detail: errorCodes[evt.code]
                    });
                };
                const sendMessage = (message) => {
                    let data = JSON.stringify(message);
                    if (connected) {
                        console.log("Sending: " + data);
                        socket.send(data)
                    }
                }
                socket.onmessage = function (m) {
                    console.log("Got message: " + m.data);
                    const msg = JSON.parse(m.data);
                    if ("CONNECTED" === msg.type) {
                        updateOpponentName('')
                        updateOpponentImages('NONE')
                        sendMessage({
                            type: "NEW_GAME"
                        })
                    }
                    if ("WAITING_PLAYERS" === msg.type) {
                        state.GAME_ID = msg.data.GAME_ID;
                        updateOpponentName('')
                        updateOpponentImages('NONE')
                        hidePanels();
                        gamePanel.show();
                        board.show();
                        waitingPlayers.show();
                        leavePanel.show();
                        boardMovement.enable();
                    }
                    if ("GAME_OVER_ABANDONED" === msg.type) {
                        updateOpponentName(msg.data.OPPONENT_NAME)
                        updateOpponentImages('whereistheopponent')
                        state.GAME_ID = msg.data.GAME_ID;
                        waitingPlayers.hide();
                        gameRunning.hide();
                        board.hide();
                        youLose.hide();
                        youWin.hide();
                        abandoned.show();
                        tied.hide();
                        leavePanel.hide();
                        tryPanel.show();
                        socket.close()
                    }
                    if ("GAME_OVER_YOU_LOSE" === msg.type) {
                        updateOpponentName(msg.data.OPPONENT_NAME)
                        updateOpponentImages(msg.data.OPPONENT_MOVEMENT)
                        state.GAME_ID = msg.data.GAME_ID;
                        waitingPlayers.hide();
                        gameRunning.hide();
                        board.hide();
                        youLose.show();
                        youWin.hide();
                        abandoned.hide();
                        tied.hide();
                        leavePanel.hide();
                        tryPanel.show();
                        socket.close()
                    }
                    if ("GAME_OVER_YOU_WIN" === msg.type) {
                        updateOpponentName(msg.data.OPPONENT_NAME)
                        updateOpponentImages(msg.data.OPPONENT_MOVEMENT)
                        state.GAME_ID = msg.data.GAME_ID;
                        waitingPlayers.hide();
                        gameRunning.hide();
                        board.hide();
                        youLose.hide();
                        youWin.show();
                        abandoned.hide();
                        tied.hide();
                        leavePanel.hide();
                        tryPanel.show();
                        socket.close()
                    }
                    if ("GAME_OVER_DRAW" === msg.type) {
                        updateOpponentName(msg.data.OPPONENT_NAME)
                        updateOpponentImages(msg.data.OPPONENT_MOVEMENT)
                        state.GAME_ID = msg.data.GAME_ID;
                        waitingPlayers.hide();
                        gameRunning.hide();
                        board.hide();
                        youLose.hide();
                        youWin.hide();
                        abandoned.hide();
                        tied.show();
                        leavePanel.hide();
                        tryPanel.show();
                        socket.close()
                    }
                    if ("GAME_READY" === msg.type) {
                        updateOpponentName(msg.data.OPPONENT_NAME)
                        updateOpponentImages('NONE')
                        state.GAME_ID = msg.data.GAME_ID
                        waitingPlayers.hide()
                        leavePanel.show();
                        gameRunning.show();
                        progressBar.reset();
                        const interval = setInterval(() => {
                            progressBar.decrease(20);
                        }, 1000);
                        const timeout = setTimeout(() => {
                            clearInterval(interval);
                            boardMovement.disable();
                            const n = {
                                type: "PLAY_GAME",
                                data: {
                                    GAME_ID: state.GAME_ID,
                                    MOVEMENT: state.MOVEMENT
                                }
                            };
                            sendMessage(n);
                            clearTimeout(timeout);
                        }, 5000)
                    }
                };
            }
        };

    })
    ()
</script>

<noscript>Please enable JavaScript to continue using this application.</noscript>
</body>
</html>